#include "resnet.hpp"
#include "dataset.hpp"
#include "mem_pool.h"

using namespace Impl;
using namespace std;

int _main() {
  // 1. load resnet18 model
  // 2. load image dataset
  // 3. inference

#ifdef DATASET_ROOT
#ifdef RESNET18_ROOT

  // TODO: argument parsing
#if SIMULATE
  cout << "Only simulate one round." << endl;
  auto dataset = Impl::ImageDataset(DATASET_ROOT, Impl::DeviceType::CUDA, 1);
#else
  auto dataset = Impl::ImageDataset(DATASET_ROOT, Impl::DeviceType::CUDA);
#endif
  string model_path = RESNET18_ROOT;
  model_path += "/resnet18";
  ResNet18 resnet18(model_path);
  resnet18.to(Impl::DeviceType::CUDA);
  resnet18.printModule("resnet18");
  std::cout << std::endl;

  int num_correct = 0;
  int num_total = 0;
  SimpleTimer timer;
  for (int i = 0; i < dataset.size(); i++) {
    timer.start("forward");
    auto data = dataset.next();
    auto result = std::move(resnet18.forward(std::move(data.first.first)));

    result.to(Impl::DeviceType::CPU);
    auto label = std::move(data.first.second);
    label.to(Impl::DeviceType::CPU);

    Tensor original_label = TensorOps::argmax(label, 1);
    Tensor predicted_result = TensorOps::argmax(result, 1);

    auto correct = TensorOps::sum_equal(original_label, predicted_result);
    num_correct += correct;
    num_total += predicted_result.sizes()[0];
    timer.end("forward");
  }
  timer.printStat("forward");

  std::cout << "Accuracy Compared to PyTorch ResNet18 Implementation: " << num_correct << "/" << num_total << std::endl;
#endif
#endif

#ifndef DATASET_ROOT
  std::cout << "Dataset not found by CMake. Check CMake output." << std::endl;
#endif

#ifndef RESNET18_ROOT
  std::cout << "ResNet 18 weights not generated by CMake. Check CMake output." << std::endl;
#endif

  return 0;

}

int main() {
  init_mem_pool();
  _main();
  deinit_mem_pool();
  return 0;
}
